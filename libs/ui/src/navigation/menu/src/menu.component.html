<div [class]="rootKlass()">
  <!-- Trigger -->
  <button
    #triggerEl
    type="button"
    [class]="triggerKlass()"
    aria-haspopup="menu"
    [attr.aria-expanded]="isOpen()"
    (click)="onTriggerClick()"
  >
    <ng-content select="[tngMenuTrigger]"></ng-content>
  </button>

  <!-- Overlay -->
  <tng-overlay-ref
    [open]="isOpen()"
    (openChange)="onOverlayOpenChange($event)"
    (opened)="onOverlayOpened()"
    (closed)="onOverlayClosed($event)"
  >
    <!-- NEW: Backdrop only when modal -->
     @if (modal() && isOpen()) {
      <div
        [class]="backdropKlass()"
        class="z-[999]"
        (click)="onBackdropClick()"
      ></div>
    }

    <tng-connected-overlay
      [open]="isOpen()"
      [anchor]="triggerEl"
      [placement]="placement()"
      [offset]="offset()"
      [width]="width()"
      [closeOnOutsideClick]="effectiveCloseOnOutsideClick()"
      [closeOnEscape]="effectiveCloseOnEscape()"
      (closed)="onOverlayClosed($event)"
    >
      <!-- Key change: pass modal into overlay-panel -->
      <tng-overlay-panel
        [klass]="panelKlass()"
        [modal]="modal()"
        role="menu"
      >
        <!-- Render the projected <ng-template> content -->
      @if (menuTpl) {
        <ng-container
          [ngTemplateOutlet]="menuTpl">
        </ng-container>
      } @else {
        <!-- Fallback: support <div tngMenuContent>...</div> -->
        <ng-content select="[tngMenuContent]"></ng-content>
      }
      </tng-overlay-panel>
    </tng-connected-overlay>
  </tng-overlay-ref>
</div>
