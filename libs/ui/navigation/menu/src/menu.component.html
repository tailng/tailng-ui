<div [class]="rootKlass()">
  <!-- Trigger -->
  <button
    #triggerEl
    type="button"
    [class]="triggerKlass()"
    aria-haspopup="menu"
    [attr.aria-expanded]="isOpen()"
    (click)="onTriggerClick()"
  >
    <ng-content select="[tngMenuTrigger]"></ng-content>
  </button>

  <!-- Overlay -->
  <tng-overlay-ref
    [open]="isOpen()"
    (openChange)="onOverlayOpenChange($event)"
    (opened)="onOverlayOpened()"
    (closed)="onOverlayClosed($event)"
  >
    <!-- NEW: Backdrop only when modal -->
    <ng-container *ngIf="modal() && isOpen()">
      <div
        [class]="backdropKlass()"
        class="z-[999]"
        (click)="onBackdropClick()"
      ></div>
    </ng-container>

    <tng-connected-overlay
      [open]="isOpen()"
      [anchor]="triggerEl"
      [placement]="placement()"
      [offset]="offset()"
      [width]="width()"
      [closeOnOutsideClick]="effectiveCloseOnOutsideClick()"
      [closeOnEscape]="effectiveCloseOnEscape()"
      (closed)="onOverlayClosed($event)"
    >
      <!-- Key change: pass modal into overlay-panel -->
      <tng-overlay-panel
        [klass]="panelKlass()"
        [modal]="modal()"
        role="menu"
      >
        <!-- âœ… Render the projected <ng-template> content -->
        <ng-container *ngIf="menuTpl; else contentSlot"
          [ngTemplateOutlet]="menuTpl"
        ></ng-container>

        <!-- Fallback: support <div tngMenuContent>...</div> -->
        <ng-template #contentSlot>
          <ng-content select="[tngMenuContent]"></ng-content>
        </ng-template>
      </tng-overlay-panel>
    </tng-connected-overlay>
  </tng-overlay-ref>
</div>
